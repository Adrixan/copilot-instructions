name: Validate Instructions

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run markdownlint
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: .markdownlint.json

  lint-yaml:
    name: Lint YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yml

  validate-examples:
    name: Validate Code Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check:
          - name: Python
            path: examples/backend/python
            command: |
              python -m pip install --upgrade pip
              pip install pytest mypy black flake8
              black --check .
              flake8 --max-line-length=88 .
              mypy --strict .
              pytest --verbose

          - name: Shell Scripts
            path: examples/scripting
            command: |
              shellcheck *.sh || true
              bash -n deploy.sh

          - name: TypeScript
            path: examples/web/react
            command: |
              npm install --global typescript @types/react @types/react-dom
              tsc --noEmit --strict *.tsx || true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        if: matrix.check.name == 'Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup Node.js
        if: matrix.check.name == 'TypeScript'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install ShellCheck
        if: matrix.check.name == 'Shell Scripts'
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run validation
        working-directory: ${{ matrix.check.path }}
        run: ${{ matrix.check.command }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Detect hardcoded secrets (pull request)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

      - name: Detect hardcoded secrets (push)
        if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}

  validate-structure:
    name: Validate Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required files
        run: |
          required_files=(
            "copilot-instructions.md"
            "README.md"
            "LICENSE"
            "instructions/ops-shared.instructions.md"
            "instructions/backend-shared.instructions.md"
            "instructions/web.instructions.md"
            "instructions/scripting-shared.instructions.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

      - name: Validate instruction files have applyTo
        run: |
          instruction_files=(
            "instructions/ops-shared.instructions.md"
            "instructions/backend-shared.instructions.md"
            "instructions/web.instructions.md"
            "instructions/scripting-shared.instructions.md"
          )

          for file in "${instruction_files[@]}"; do
            if ! grep -q "applyTo:" "$file"; then
              echo "❌ Missing 'applyTo:' in $file"
              exit 1
            fi
            echo "✅ Valid: $file"
          done

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [lint-markdown, lint-yaml, validate-examples, security-scan, validate-structure]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint-markdown.result }}" != "success" ] || \
             [ "${{ needs.lint-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-examples.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "❌ Some checks failed"
            exit 1
          fi
          echo "✅ All checks passed"
